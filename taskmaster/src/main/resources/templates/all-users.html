<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{/fragments/head::head}"></head>
<body>
<nav th:replace="~{/fragments/navigation::nav}"></nav>
<div class="bg-background text-foreground min-h-screen p-4 flex flex-col items-center mb-8">
    <div class="flex w-[70em] justify-center mb-4">
        <h1 class="text-3xl ml-auto  mb-4 text-center">All users</h1>
        <div class="flex items-center space-x-2 ml-auto">
            <label for="today-sort-by" class="text-zinc-600">Sort by:</label>
            <select th:selected="${@userPagingAndSortingService.getSortBy()}"
                    onchange="sortBy(this.value)" id="today-sort-by"
                    class="bg-input text-zinc-600 border border-input rounded-md px-2 py-1 pr-8">
                <option value="id">None</option>
                <option value="username">Username</option>
                <option value="fullName">Full Name</option>
                <option value="email">Email</option>
                <option value="age">Age</option>
            </select>
            <select th:selected="${@userPagingAndSortingService.getSortBy()}"
                    onchange="sortBy(this.value)" id=""
                    class="bg-input text-zinc-600 border border-input rounded-md px-2 py-1 pr-8">
                <option value="id">None</option>
                <option value="username">Username</option>
                <option value="fullName">Full Name</option>
                <option value="email">Email</option>
                <option value="age">Age</option>
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                <svg class="h-4 w-4 text-zinc-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                     xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M19 9l-7 7-7-7"></path>
                </svg>
            </div>
        </div>
    </div>
    <div class="overflow-x-auto w-[70em]">
        <table class="min-w-full bg-card rounded-lg table-fixed">
            <thead>
            <tr>
                <th class="px-4 py-2 bg-primary text-primary-foreground font-bold uppercase text-sm">Username</th>
                <th class="px-4 py-2 bg-primary text-primary-foreground font-bold uppercase text-sm">Full Name</th>
                <th class="px-4 py-2 bg-primary text-primary-foreground font-bold uppercase text-sm">Email</th>
                <th class="px-4 py-2 bg-primary text-primary-foreground font-bold uppercase text-sm">Age</th>
                <th class="px-4 py-2 bg-primary text-primary-foreground font-bold uppercase text-sm">Role</th>
                <th class="px-4 py-2 bg-primary text-primary-foreground font-bold uppercase text-sm">Actions</th>
            </tr>
            </thead>
            <tbody id="users">
            <tr th:each="user : ${foundedUsers}" th:object="${user}" th:id="*{id + '-section'}">
                <td th:text="*{username}" class="px-4 py-2 text-center">JohnDoe</td>
                <td th:text="*{fullName}" class="px-4 py-2 text-center">John Doe</td>
                <td th:text="*{email}" class="px-4 py-2 text-center">john.doe@example.com</td>
                <td th:text="*{age}" class="px-4 py-2 text-center">22</td>
                <td th:text="*{isAdmin}? 'Admin' : 'User'" th:id="*{id + '-role'}" class="px-4 py-2 text-center">Admin
                </td>
                <td class="px-4 py-2 text-center">
                    <button th:id="*{id}"
                            th:text="*{isAdmin}? 'Remove Admin' : 'Make Admin'"
                            class="make-remove-admin mr-2 bg-accent text-accent-foreground px-2 py-1 rounded-lg ml-2">
                        Make Admin
                    </button>
                    <button th:id="*{id}" th:data-username="*{username}"
                            class="edit-button bg-secondary text-secondary-foreground px-2 py-1 rounded-lg">Edit
                    </button>
                    <button th:id="*{id}" th:data-username="*{username}"
                            class="change-password-button bg-destructive text-destructive-foreground px-2 py-1 rounded-lg ml-2">
                        Change
                        password
                    </button>
                    <button th:id="*{id}"
                            class="delete-button bg-destructive text-destructive-foreground px-2 py-1 rounded-lg ml-2">
                        Delete
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
        <div class=" mt-4 flex justify-end">
            <button th:if="${@userPagingAndSortingService.hasPrevPage()}"
                    onclick="prevPage()"
                    class="ref-on-click bg-primary text-primary-foreground px-2 py-2 mr-4 rounded-lg ">Previous
            </button
            >
            <button th:if="${@userPagingAndSortingService.haseNextPage()}"
                    onclick="nextPage()"
                    class="ref-on-click bg-primary text-primary-foreground px-2 py-2 rounded-lg ">Next
            </button>
        </div>
    </div>
    <form th:method="put" th:action="@{/users}"
          th:object="${editData}"
          class="hidden flex flex-col justify-center gap-6 mt-4  w-[68.8%]"
          id="editSection">
        <h2 id="editLabel" class="text-2xl mb-2 border-solid border-b-2 border-black pb-2 rem mb-4">Edit</h2>
        <input th:field="*{id}" type="hidden" id="editDataUserId">
        <div class="flex gap-8">
            <div class="w-full md:w-1/2">
                <label class="block mb-3" for="username">Username</label>
                <input th:field="*{username}" id="username" type="text"
                       class="w-full  text-black border border-primary rounded-md px-3 py-2 mb-2"
                       placeholder="Username"/>
                <div th:errors="*{username}"
                     class="text-sm text-destructive">
                    <p>Username length must be between 5 and 15 symbols!</p>
                </div>
            </div>
            <div class="w-full md:w-1/2">
                <label class="block mb-3" for="fullName">Full Name</label>
                <input th:field="*{fullName}" id="fullName" type="text"
                       class="w-full  text-black border border-primary rounded-md px-3 py-2 mb-2"
                       placeholder="FullName"/>
                <div th:errors="*{fullName}"
                     class="text-sm text-destructive">
                    <p>Username length must be between 5 and 15 symbols!</p>
                </div>
            </div>
        </div>
        <div class="flex gap-8">
            <div class="w-full md:w-1/2">
                <label class="block mb-3" for="email">Email</label>
                <input th:field="*{email}" id="email" type="email"
                       class="w-full  text-black border border-primary rounded-md px-3 py-2 mb-2"
                       placeholder="Email"/>
                <div th:errors="*{email}"
                     class="text-sm text-destructive">
                    <p>Username length must be between 5 and 15 symbols!</p>
                </div>
            </div>
            <div class="w-full md:w-1/2">
                <label class="block mb-3" for="age">Age</label>
                <input th:field="*{age}" id="age" type="number"
                       class="w-full  text-black border border-primary rounded-md px-3 py-2 mb-2"
                       placeholder="Age"/>
                <div th:errors="*{age}"
                     class="text-sm text-destructive">
                    <p>Username length must be between 5 and 15 symbols!</p>
                </div>
            </div>
        </div>
        <div class="flex justify-start">
            <button class="bg-primary text-primary-foreground px-4 py-2 rounded-lg">Save Changes</button>
        </div>
    </form>

    <form th:method="patch"
          th:action="@{/users/change-password}"
          th:object="${changePasswordData}"
          class="p-6 min-w-[45em] hidden" id="changePasswordSection">
        <input th:field="*{id}" type="hidden" id="changePasswordUserId">
        <h2 id="changePasswordLabel"
            class="text-2xl mb-2 border-solid border-b-2 border-black pb-2 rem mb-4">Change Password</h2>
        <div class="flex gap-4">
            <div class="mb-4 w-full md:w-1/2">
                <label th:for="newPassword" class="mb-3 block text-sm font-medium text-primary">New Password</label>
                <input th:field="*{newPassword}" id="newPassword" type="password"
                       class="w-full px-3 py-2 placeholder-input text-black border rounded-lg focus:outline-none focus:ring ring-primary"
                       placeholder="Enter your new password"/>
                <div th:errors="*{newPassword}"
                     class="text-sm text-destructive">
                    <p>Password length must be between 2 and 15 symbols!</p>
                </div>
                <div th:errors="global"
                     class="text-sm text-destructive">
                    <p>Password length must be between 2 and 15 symbols!</p>
                </div>
            </div>
            <div class="mb-4 w-full md:w-1/2">
                <label th:for="confirmPassword" class="mb-3 block text-sm font-medium text-primary">Confirm
                    Password</label>
                <input th:field="*{confirmPassword}"
                       id="confirmPassword"
                       type="password"
                       class="w-full px-3 py-2 placeholder-input text-black border rounded-lg focus:outline-none focus:ring ring-primary"
                       placeholder="Confirm your new password"
                />
                <div th:errors="*{confirmPassword}"
                     class="text-sm text-destructive">
                    <p>Password length must be between 2 and 15 symbols!</p>
                </div>
                <div th:errors="global"
                     class="text-sm text-destructive">
                    <p>Password length must be between 2 and 15 symbols!</p>
                </div>
            </div>
        </div>
        <div class="flex justify-start">
            <button type="submit" class="bg-primary text-primary-foreground px-4 py-2 rounded-lg">Change password
            </button>
        </div>
    </form>
    <div th:if="${showEdit != null or showChangePassword != null}" id="scroll"></div>
</div>
<footer th:replace="~{/fragments/footer::footer}"></footer>
</body>
<script>

    function getUrl(){
        return new URL(window.location);
    }

    function reload(url){
        window.location.replace(url.href);
    }
    function nextPage() {
        let url = getUrl();
        let newPage = url.searchParams.get('page') == null ? 2 : Number(url.searchParams.get('page')) + 1;
        url.searchParams.set("page", newPage);
        reload(url);
    }

    function sortBy(by) {
        let url = getUrl();
        url.searchParams.set('sortBy', by);
        reload(url);
    }

    function prevPage() {
        let url = getUrl();
        let newPage = url.searchParams.get('page') == null ? 0 : Number(url.searchParams.get('page')) - 1;
        url.searchParams.set("page", newPage);
        reload(url);
    }

</script>
<script th:if="${showEdit}">
    document.getElementById('editSection').classList.toggle('hidden', false);
    document.getElementById('changePasswordSection').classList.add('hidden');
    document.getElementById("scroll")
        .scrollIntoView({block: "end", behavior: "smooth"});
</script>
<script th:if="${showChangePassword}">
    document.getElementById('changePasswordSection').classList.toggle('hidden', false);
    document.getElementById('editSection').classList.add('hidden');
    document.getElementById("scroll")
        .scrollIntoView({block: "end", behavior: "smooth"});
</script>
<script th:src="@{/js/user-make-remove-admin.js}"></script>
<script th:src="@{/js/edit-user.js}"></script>
<script th:src="@{/js/delete-user.js}"></script>
<script th:src="@{/js/chage-user-password.js}"></script>
</html>